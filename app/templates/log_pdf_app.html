<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Logbook APP Entry #{{ log.id }}</title>
    <style>
        @page {
            size: A4;
            margin: 1cm;
        }
        body {
            font-family: sans-serif;
            font-size: 9px;
        }
        .container {
            width: 100%;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            page-break-inside: avoid;
        }
        .card-header {
            padding: 0.4rem 0.75rem;
            background-color: #f2f2f2;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .card-body {
            padding: 0.75rem;
        }
        .text-center {
            text-align: center;
        }
        .text-start {
            text-align: left;
        }
        dl {
            display: grid;
            grid-template-columns: 150px auto; 
            margin: 0;
            padding: 0;
        }
        dt {
            font-weight: bold;
            padding: 2px;
        }
        dd {
            margin-left: 0;
            padding: 2px;
        }
        pre {
            white-space: pre-wrap;
            font-family: sans-serif;
            margin: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 0.3rem;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word; 
        }
        thead th {
            background-color: #f2f2f2;
        }
        .facility-container {
            display: block;
        }
        .facility-column {
            width: 100%;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center">
            {% if logo_path %}
            <img src="file://{{ logo_path }}" alt="AirNav Logo" style="height: 50px; margin-bottom: 10px;">
            {% endif %}
            <h3 style="margin-top: 0; margin-bottom: 0;">Approach Control Unit Yogyakarta Radar</h3>
            <p>Logbook Entry #{{ log.id }}</p>
        </div>

        <div class="card">
            <div class="card-header">General Information</div>
            <div class="card-body">
                <dl>
                    <dt>Day & Date</dt>
                    <dd>{{ log.log_date.strftime('%d %B %Y') }}</dd>
                    <dt>Shift</dt>
                    <dd>{{ log.shift }}</dd>
                    <dt>ATC on Duty</dt>
                    <dd>{{ log.atc_on_duty_personnel | map(attribute='name') | join(', ') or 'N/A' }}</dd>
                    <dt>NOTAM</dt>
                    <dd><pre>{{ log.notam or 'N/A' }}</pre></dd>
                </dl>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ATC Position Seat</div>
            <div class="card-body">
                <table class="text-center">
                    <thead>
                        <tr>
                            <th class="text-start">Position / Time</th>
                            {% for i in range(1, 7) %}
                                <th>{{ log.atc_position_header['header_' ~ i] if log.atc_position_header and log.atc_position_header['header_' ~ i] else 'Start-End' }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% set positions = ["SUPERVISOR", "CONTROLLER RADAR 123.4 Mhz", "ASSISTANCE RADAR 123.4 Mhz", "CONTROLLER RADAR 120.2 Mhz", "ASSISTANCE RADAR 120.2 Mhz", "REST"] %}
                        {% for position_name in positions %}
                        <tr>
                            <td class="text-start"><strong>{{ position_name }}</strong></td>
                            {% set pos_data = atc_positions.get(position_name) %}
                            {% for i in range(1, 7) %}
                            <td>{{ pos_data['time_slot_' ~ i] if pos_data and pos_data['time_slot_' ~ i] else '-' }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Facilities Status Check</div>
            <div class="card-body facility-container">
                <div class="facility-column">
                    {% if grouped_facilities['COM. & NAV.'] %}
                    <h5>COM. & NAV.</h5>
                    <table>
                        <thead>
                            <tr><th>FACILITIES</th><th>REMARK</th><th>Cond.</th><th>Notes</th></tr>
                        </thead>
                        <tbody>
                        {% for facility in grouped_facilities['COM. & NAV.'] %}
                            <tr>
                                {% set current_status = log.facility_statuses | selectattr("facility_id", "equalto", facility.id) | first %}
                                <td>{{ facility.name }}</td>
                                <td>{{ facility.remark or 'N/A' }}</td>
                                <td>
                                    {% if current_status %}
                                        {% set cond = current_status.condition.value %}
                                        {% if cond == '1' %}1 - Unreadable
                                        {% elif cond == '2' %}2 - Readable Now & Then
                                        {% elif cond == '3' %}3 - Readable but with difficulty
                                        {% elif cond == '4' %}4 - Readable
                                        {% elif cond == '5' %}5 - Perfectly Readable
                                        {% elif cond == 'G' %}G - Good
                                        {% elif cond == 'F' %}F - Fair
                                        {% elif cond == 'P' %}P - Poor
                                        {% elif cond == 'U/S' %}U/S - Unserviceable
                                        {% else %}{{ cond }}{% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>{{ current_status.notes if current_status else '' }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
                <div class="facility-column">
                    {% if grouped_facilities['FACILITIES'] %}
                    <h5>FACILITIES</h5>
                    <table>
                        <thead>
                            <tr><th>FACILITIES</th><th>REMARK</th><th>Cond.</th><th>Notes</th></tr>
                        </thead>
                        <tbody>
                        {% for facility in grouped_facilities['FACILITIES'] %}
                            <tr>
                                {% set current_status = log.facility_statuses | selectattr("facility_id", "equalto", facility.id) | first %}
                                <td>{{ facility.name }}</td>
                                <td>{{ facility.remark or 'N/A' }}</td>
                                <td>
                                    {% if current_status %}
                                        {% set cond = current_status.condition.value %}
                                        {% if cond == 'G' %}G - Good
                                        {% elif cond == 'F' %}F - Fair
                                        {% elif cond == 'P' %}P - Poor
                                        {% elif cond == 'U/S' %}U/S - Unserviceable
                                        {% else %}{{ cond }}{% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>{{ current_status.notes if current_status else '' }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Description of Activities</div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 15%;">Time (UTC)</th>
                            <th>Description</th>
                            <th style="width: 25%;">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if log.operational_logs %}
                            {% for op_log in log.operational_logs %}
                            <tr>
                                <td>{{ op_log.event_time.strftime('%H:%M') }}</td>
                                <td><pre>{{ op_log.description }}</pre></td>
                                <td>{{ op_log.remarks or '' }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" class="text-center">No activities recorded.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px; page-break-before: auto;">
            <div class="card-body">
                <table class="text-center">
                    <thead>
                        <tr>
                            <th style="width: 33.3%;">Transferring Controller On Duty</th>
                            <th style="width: 33.3%;">Accepting Controller On Duty (Transfer of Duty)</th>
                            <th style="width: 33.3%;">Manager Operation On Duty</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="height: 60px; vertical-align: bottom;">
                                {% if signature_paths.controller_1 %}
                                    <img src="file://{{ signature_paths.controller_1 }}" style="max-height: 50px; max-width: 120px;">
                                {% endif %}
                            </td>
                            <td style="height: 60px; vertical-align: bottom;">
                                {% if signature_paths.controller_2 %}
                                    <img src="file://{{ signature_paths.controller_2 }}" style="max-height: 50px; max-width: 120px;">
                                {% endif %}
                            </td>
                            <td style="height: 60px; vertical-align: bottom;">
                                {% if signature_paths.manager %}
                                    <img src="file://{{ signature_paths.manager }}" style="max-height: 50px; max-width: 120px;">
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>