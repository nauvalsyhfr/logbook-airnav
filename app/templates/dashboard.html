{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">Dashboard - Operation Division</h1>
        <p class="text-muted mb-0">
            Logbook untuk: 
            <strong class="text-primary">
                {% if logbook_type == 'APP' %}
                    Approach Control Unit Yogyakarta Radar
                {% else %}
                    Aerodrome Control Tower Yogyakarta International Airport
                {% endif %}
            </strong>
        </p>
    </div>
    <div class="btn-group">
        <a href="{{ url_for('main.create_log_entry', logbook_type=logbook_type) }}" class="btn btn-primary">
            <i class="bi bi-plus-circle-fill me-2"></i>Create New Logbook
        </a>
        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li>
                <a class="dropdown-item {% if logbook_type == 'TWR' %}active{% endif %}" href="{{ url_for('main.dashboard_operasi', type='TWR') }}">
                    <i class="bi bi-building me-2"></i>Aerodrome Control Tower
                </a>
            </li>
            <li>
                <a class="dropdown-item {% if logbook_type == 'APP' %}active{% endif %}" href="{{ url_for('main.dashboard_operasi', type='APP') }}">
                    <i class="bi bi-broadcast-pin me-2"></i>Approach Control Unit
                </a>
            </li>
        </ul>
    </div>
</div>


<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'history' %}active{% endif %}" id="history-tab" href="{{ url_for('main.dashboard_operasi', tab='history', type=logbook_type) }}">Logbook History</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'recap' %}active{% endif %}" id="recap-tab" href="{{ url_for('main.dashboard_operasi', tab='recap', type=logbook_type) }}">Personnel Recap</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'personal' %}active{% endif %}" id="personal-tab" href="{{ url_for('main.dashboard_operasi', tab='personal') }}">Personal ATC Logbook</a>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade {% if active_tab == 'history' %}show active{% endif %}" id="history" role="tabpanel">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.dashboard_operasi') }}">
                    <input type="hidden" name="tab" value="history">
                    <input type="hidden" name="type" value="{{ logbook_type }}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date or '' }}">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-info me-2"><i class="bi bi-funnel-fill me-1"></i> Filter</button>
                            <a href="{{ url_for('main.dashboard_operasi', tab='history', type=logbook_type) }}" class="btn btn-secondary"><i class="bi bi-x-circle me-1"></i> Clear</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Shift</th>
                                <th>Officer on Duty</th>
                                <th style="width: 30%;">NOTAM</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in log_entries %}
                            <tr>
                                <td>{{ log.log_date.strftime('%d %B %Y') }}</td>
                                <td><span class="badge bg-secondary">{{ log.shift }}</span></td>
                                <td>{{ log.atc_on_duty_personnel | map(attribute='name') | join(', ') }}</td>
                                <td class="text-truncate" style="max-width: 200px;">{{ log.notam or 'None' }}</td>
                                <td class="text-center">
                                    <a href="{{ url_for('main.view_log', log_id=log.id) }}" class="btn btn-sm btn-info" title="View Details"><i class="bi bi-eye-fill"></i></a>
                                    <a href="{{ url_for('main.edit_log', log_id=log.id) }}" class="btn btn-sm btn-warning text-white" title="Edit"><i class="bi bi-pencil-fill"></i></a>
                                    <a href="{{ url_for('main.download_log_pdf', log_id=log.id) }}" class="btn btn-sm btn-danger" title="Download PDF"><i class="bi bi-file-earmark-pdf-fill"></i></a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    {% if start_date or end_date %} No logbook entries found for the selected date range. {% else %} No logbook entries yet. {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'recap' %}show active{% endif %}" id="recap" role="tabpanel">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.dashboard_operasi') }}">
                    <input type="hidden" name="tab" value="recap">
                    <input type="hidden" name="type" value="{{ logbook_type }}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="recap_month" class="form-label">Month</label>
                            <select class="form-select" name="recap_month">
                                {% for i in range(1, 13) %}
                                <option value="{{ i }}" {% if i == recap_month %}selected{% endif %}>{{ i | month_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="recap_year" class="form-label">Year</label>
                            <input type="number" class="form-control" name="recap_year" value="{{ recap_year }}" min="2020" max="2050">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-info"><i class="bi bi-funnel-fill me-1"></i> Show Recap</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                Rekapitulasi untuk <strong>{{ recap_month | month_name }} {{ recap_year }}</strong>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Nama Personel</th>
                                <th scope="col" class="text-center">Total Hari Bertugas</th>
                                <th scope="col" class="text-center">Total Jam Posisi (Jam)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in recap_data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ data.name }}</td>
                                <td class="text-center">{{ data.days }}</td>
                                <td class="text-center">{{ data.hours }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">Tidak ada data untuk bulan yang dipilih.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}" id="personal" role="tabpanel">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Filter Personal Logbook</h5>
                <form method="GET" action="{{ url_for('main.dashboard_operasi') }}">
                    <input type="hidden" name="tab" value="personal">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="personnel_id" class="form-label">Pilih Personel</label>
                            <select class="form-select" name="personnel_id" required>
                                <option value="" disabled {% if not selected_personnel_id %}selected{% endif %}>-- Nama Personel --</option>
                                {% for person in all_atc_personnel %}
                                <option value="{{ person.id }}" {% if person.id == selected_personnel_id %}selected{% endif %}>{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="personal_month" class="form-label">Bulan</label>
                            <select class="form-select" name="personal_month">
                                {% for i in range(1, 13) %}
                                <option value="{{ i }}" {% if i == personal_month %}selected{% endif %}>{{ i | month_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="personal_year" class="form-label">Tahun</label>
                            <input type="number" class="form-control" name="personal_year" value="{{ personal_year }}" min="2020" max="2050">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-info w-100"><i class="bi bi-search me-1"></i> Tampilkan</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if selected_personnel_id %}
            {% if personal_log_data %}
            <div class="card shadow-sm">
                <div class="card-header">
                    Logbook untuk: <strong>{{ personal_log_summary.selected_personnel_name }}</strong> | Periode: <strong>{{ personal_month | month_name }} {{ personal_year }}</strong>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center">Tanggal</th>
                                    <th class="text-center">Shift</th> {# <-- Header baru ditambahkan #}
                                    <th class="text-center">Unit</th>
                                    <th>Posisi</th>
                                    <th class="text-center">Durasi (Jam)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in range(1, personal_log_summary.num_days + 1) %}
                                    {% if day in personal_log_data %}
                                        {% for duty in personal_log_data[day] %}
                                        <tr>
                                            <td class="text-center">{{ duty.date.strftime('%d-%m-%Y') }}</td>
                                            {#- Sel baru ditambahkan untuk Shift --#}
                                            <td class="text-center"><span class="badge bg-secondary">{{ duty.shift }}</span></td>
                                            <td class="text-center"><span class="badge {% if duty.unit == 'TWR' %}bg-primary{% else %}bg-success{% endif %}">{{ duty.unit }}</span></td>
                                            <td>{{ duty.position }}</td>
                                            <td class="text-center">{{ "%.2f"|format(duty.duration.total_seconds() / 3600) }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-group-divider">
                                <tr>
                                    {#-- PERUBAHAN: Colspan disesuaikan karena ada kolom baru --#}
                                    <td colspan="3" rowspan="3" class="align-middle text-center"><strong>TOTAL REKAPITULASI</strong></td>
                                    <td><strong>Controller (CTR)</strong></td>
                                    <td class="text-center"><strong>{{ personal_log_summary.total_ctr_hours }} Jam</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Assistance/Supervisor (ASS)</strong></td>
                                    <td class="text-center"><strong>{{ personal_log_summary.total_ass_hours }} Jam</strong></td>
                                </tr>
                                <tr class="table-info">
                                    <td><strong>GRAND TOTAL</strong></td>
                                    <td class="text-center"><strong>{{ personal_log_summary.grand_total_hours }} Jam</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center mt-4">
                Tidak ada data jam kerja yang tercatat untuk <strong>{{ all_atc_personnel | selectattr('id', 'equalto', selected_personnel_id) | map(attribute='name') | first }}</strong> pada periode <strong>{{ personal_month | month_name }} {{ personal_year }}</strong>.
            </div>
            {% endif %}
        {% else %}
        <div class="alert alert-info text-center mt-4">
            <i class="bi bi-info-circle-fill me-2"></i> Silakan pilih nama personel dan periode untuk menampilkan logbook pribadi.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}